<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
         <record id="crm_team_form_view_rfm_inherit" model="ir.ui.view">
            <field name="name">crm.team.rfm.form</field>
            <field name="model">crm.team</field>
            <field name="inherit_id" ref="sales_team.crm_team_view_form"/>
            <field name="arch" type="xml">
                <xpath expr="//notebook" position="inside">
                    <page name="RFM" string="RFM" groups="setu_rfm_analysis.group_rfm_show_team_conf">
                        <field name="segment_rule_ids"/>
                    </page>
                </xpath>
            </field>
        </record>
        <record id="crm_team_rfm_kanban_view" model="ir.ui.view">
            <field name="name">crm.team.kanban</field>
            <field name="model">crm.team</field>
            <field name="arch" type="xml">
                <kanban class="oe_background_grey o_kanban_dashboard o_salesteam_kanban" create="0" sample="1">
                    <field name="name"/>
                    <field name="user_id"/>
                    <field name="member_ids"/>
                    <field name="color"/>
                    <field name="currency_id"/>
                    <field name="is_favorite"/>
                    <field name="use_quotations"/>
                    <field name="invoiced_target"/>
                    <field name="alias_id"/>
                    <field name="alias_name"/>
                    <field name="alias_domain"/>
                    <field name="use_opportunities"/>
                    <field name="use_leads"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div style="width:48% !important;margin-bottom:10px !important;" t-attf-class="#{!selection_mode ? kanban_color(record.color.raw_value) : ''}">
                                <div t-attf-class="o_kanban_card_header">
                                    <div class="o_kanban_card_header_title">
                                        <div class="o_primary">
                                            <field name="name"/>
                                        </div>
                                        <div t-if="record.use_leads.raw_value and record.alias_name.value and record.alias_domain.value">
                                            <small t-translation="off"><i class="fa fa-envelope-o" aria-label="Leads"
                                                                          title="Leads" role="img"/>&amp;nbsp;
                                                <field name="alias_id"/>
                                            </small>
                                        </div>
                                    </div>
                                    <div class="o_kanban_manage_button_section">
                                        <a class="o_kanban_manage_toggle_button" href="#">
                                            <i class="fa fa-ellipsis-v" role="img" aria-label="Manage" title="Manage"/>
                                        </a>
                                    </div>
                                </div>
                                <div class="container o_kanban_card_content">
                                    <div class="row o_kanban_card_upper_content">
                                        <div class="col-4 o_kanban_primary_left" name="to_replace_in_sale_crm">
                                            <button type="object" class="btn btn-primary"
                                                    name="action_open_segments">
                                                Segments
                                            </button>
                                        </div>
                                        <div class="col-8 o_kanban_primary_right" style="padding-bottom:0;">
                                            <t name="first_options"/>
                                            <div class="row" t-if="record.lead_unassigned_count.raw_value">
                                                <div class="col-8">
                                                    <a name="%(crm.crm_case_form_view_salesteams_lead)d" type="action"
                                                       context="{'search_default_unassigned_leads': 1}">
                                                        <field name="lead_unassigned_count"/>
                                                        <t t-if="record.lead_unassigned_count.raw_value == 1">Unassigned
                                                            Lead
                                                        </t>
                                                        <t t-else="">Unassigned Leads</t>
                                                    </a>
                                                </div>
                                            </div>
                                            <div class="row" t-if="record.opportunities_count.raw_value">
                                                <div class="col-8">
                                                    <a name="%(crm.crm_case_form_view_salesteams_opportunity)d" type="action"
                                                       context="{'search_default_open_opportunities': True}"> <!-- context="{'search_default_probability': NOT or < 100}" -->
                                                        <field name="opportunities_count"/>
                                                        <t t-if="record.opportunities_count.raw_value == 1">Open
                                                            Opportunity
                                                        </t>
                                                        <t t-else="">Open Opportunities</t>
                                                    </a>
                                                </div>
                                                <div class="col-4 text-right text-truncate">
                                                    <field name="opportunities_amount" widget="monetary"
                                                           options="{'currency_field': 'currency_id'}"/>
                                                </div>
                                            </div>
                                            <div class="row" t-if="record.opportunities_overdue_count.raw_value">
                                                <div class="col-8">
                                                    <a name="%(crm.crm_lead_action_team_overdue_opportunity)d" type="action">
                                                        <field name="opportunities_overdue_count"/>
                                                        <t t-if="record.opportunities_overdue_count.raw_value == 1">
                                                            Overdue Opportunity
                                                        </t>
                                                        <t t-else="">Overdue Opportunities</t>
                                                    </a>
                                                </div>
                                                <div class="col-4 text-right text-truncate">
                                                    <field name="opportunities_overdue_amount" widget="monetary"
                                                           options="{'currency_field': 'currency_id'}"/>
                                                </div>
                                            </div>
                                            <t name="second_options"/>
                                            <div class="row" t-if="record.quotations_count.raw_value">
                                                <div class="col-8">
                                                    <a name="%(sale.action_quotations_salesteams)d" type="action"
                                                       context="{'search_default_draft': True, 'search_default_sent': True}">
                                                        <field name="quotations_count"/>
                                                        <t t-if="record.quotations_count.raw_value == 1">Quotation</t>
                                                        <t t-else="">Quotations</t>
                                                    </a>
                                                </div>
                                                <div class="col-4 text-right text-truncate">
                                                    <field name="quotations_amount" widget="monetary"/>
                                                </div>
                                            </div>
                                            <div class="row" name="orders_to_invoice"
                                                 t-if="record.sales_to_invoice_count.raw_value">
                                                <div class="col-8">
                                                    <a name="%(sale.action_orders_to_invoice_salesteams)d" type="action">
                                                        <field name="sales_to_invoice_count"/>
                                                        <t t-if="record.sales_to_invoice_count.raw_value == 1">Order to
                                                            Invoice
                                                        </t>
                                                        <t t-else="">Orders to Invoice</t>
                                                    </a>
                                                </div>
                                            </div>
                                            <t name="third_options"/>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12 o_kanban_primary_bottom">
                                            <t t-call="SalesTeamDashboardGraph"/>
                                        </div>
                                        <div class="col-12 o_kanban_primary_bottom bottom_block">
                                            <t groups="sales_team.group_sale_manager">
                                                <t t-if="record.invoiced_target.raw_value"
                                                   class="col-12 o_kanban_primary_bottom">
                                                    <field name="invoiced" widget="progressbar" title="Invoicing"
                                                           options="{'current_value': 'invoiced', 'max_value': 'invoiced_target', 'editable': true, 'edit_max_value': true, 'on_change': 'update_invoiced_target'}"/>
                                                </t>
                                                <t t-if="!record.invoiced_target.raw_value"
                                                   class="col-12 o_kanban_primary_bottom text-center">
                                                    <a href="#" class="sales_team_target_definition o_inline_link">Click
                                                        to define an invoicing target
                                                    </a>
                                                </t>
                                            </t>
                                        </div>
                                    </div>
                                </div>
                                <div class="container o_kanban_card_manage_pane dropdown-menu" role="menu">
                                    <div class="row">
                                        <div class="col-4 o_kanban_card_manage_section o_kanban_manage_view">
                                            <div role="menuitem" class="o_kanban_card_manage_title">
                                                <span>View</span>
                                            </div>
                                            <div t-if="record.use_quotations.raw_value">
                                                <a name="%(sale.action_quotations_salesteams)d" type="action" class="o_quotation_view_button">Quotations
                                                </a>
                                            </div>
                                            <div>
                                                <a name="%(sale.action_orders_salesteams)d" type="action">Sales Orders</a>
                                            </div>
                                            <div groups="account.group_account_invoice">
                                                <a name="%(sale.action_invoice_salesteams)d" type="action">Invoices</a>
                                            </div>
                                            <div t-if="record.use_leads.raw_value" groups="crm.group_use_lead">
                                                <a name="%(crm.crm_case_form_view_salesteams_lead)d" type="action">
                                                    Leads
                                                </a>
                                            </div>
                                            <div t-if="record.use_opportunities.raw_value">
                                                <a name="%(crm.crm_case_form_view_salesteams_opportunity)d" type="action">
                                                    Opportunities
                                                </a>
                                            </div>
                                        </div>
                                        <div class="col-4 o_kanban_card_manage_section o_kanban_manage_new">
                                            <div role="menuitem" class="o_kanban_card_manage_title">
                                                <span>New</span>
                                            </div>
                                            <div t-if="record.use_quotations.raw_value">
                                                <a name="%(sale.action_quotation_form)d" type="action">
                                                    Quotation
                                                </a>
                                            </div>
                                            <div t-if="record.use_opportunities.raw_value">
                                                <a name="%(crm.action_opportunity_form)d" type="action">
                                                    Opportunity
                                                </a>
                                            </div>
                                        </div>
                                        <div class="col-4 o_kanban_card_manage_section o_kanban_manage_reports">
                                            <div role="menuitem" class="o_kanban_card_manage_title">
                                                <span>Reporting</span>
                                            </div>
                                            <div name="sales_report">
                                                <a name="%(sale.action_order_report_so_salesteam)d" type="action">
                                                    Sales
                                                </a>
                                            </div>
                                            <div groups="account.group_account_invoice" name="invoices_report">
                                                <a name="%(sale.action_account_invoice_report_salesteam)d" type="action">
                                                    Invoices
                                                </a>
                                            </div>
                                            <div t-if="record.use_leads.raw_value" groups="crm.group_use_lead">
                                                <a name="%(crm.action_report_crm_lead_salesteam)d" type="action">
                                                    Leads
                                                </a>
                                            </div>
                                            <div t-if="record.use_opportunities.raw_value">
                                                <a name="%(crm.action_report_crm_opportunity_salesteam)d" type="action">
                                                    Opportunities
                                                </a>
                                            </div>
                                            <div t-if="record.use_opportunities.raw_value">
                                                <a name="%(crm.crm_activity_report_action_team)d" type="action">
                                                    Activities
                                                </a>
                                            </div>
                                        </div>
                                    </div>

                                    <div t-if="widget.editable" class="o_kanban_card_manage_settings row"
                                         groups="sales_team.group_sale_manager">
                                        <div role="menuitem" aria-haspopup="true" class="col-8">
                                            <ul class="oe_kanban_colorpicker" data-field="color" role="menu"/>
                                        </div>
                                        <div role="menuitem" class="col-4">
                                            <a class="dropdown-item" type="edit">Configuration</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                        <t t-name="SalesTeamDashboardGraph">
                            <div t-if="record.dashboard_rfm_graph_data.raw_value" class="o_sales_team_kanban_graph_section rfm_segment_graph">
                                <field name="dashboard_rfm_graph_data" widget="dashboard_graph" t-att-graph_type="'bar'"/>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <record id="actions_rfm_crm_team_server" model="ir.actions.server">
            <field name="name">Sales Teams</field>
            <field name="type">ir.actions.server</field>
            <field name="model_id" ref="model_crm_team"/>
            <field name="state">code</field>
            <field name="code">action = model.open_company_wise_teams()</field>
        </record>

        <record id="crm_team_rfm_act_window" model="ir.actions.act_window">
            <field name="name">Sales Team</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">crm.team</field>
            <!--            <field name="view_id"/>-->
            <field name="view_id" ref="setu_rfm_analysis.crm_team_rfm_kanban_view"/>
            <field name="view_mode">kanban</field>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    There are no teams.
                </p>
            </field>
        </record>

        <menuitem id="rfm_menu_sales_team_segment" name="RFM Segments By Sales Team"
                  parent="rfm_main_menu" sequence="2"
                  groups="setu_rfm_analysis.group_sales_team_rfm"
                  action="crm_team_rfm_act_window"/>
    </data>
</odoo>
